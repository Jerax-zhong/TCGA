<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»†èƒå‘¼å¸åŠ¨åŠ›å­¦æ¨¡å‹ (ç§‘å­¦ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --color-anaerobic: #27ae60; /* ç»¿ */
            --color-aerobic: #2980b9;   /* è“ */
            --color-total: #c0392b;     /* çº¢ */
            --bg-body: #f4f6f9;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-body);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 25px;
            box-sizing: border-box;
        }

        h2 { text-align: center; color: #34495e; margin-top: 0; }

        .layout {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-box {
            flex: 2;
            height: 500px;
            position: relative;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .control-panel {
            flex: 1;
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* æ»‘å—æ ·å¼ */
        .slider-group label {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        input[type=range] {
            width: 100%;
            cursor: pointer;
        }

        /* æ•°æ®æ˜¾ç¤º */
        .metrics {
            display: grid;
            gap: 10px;
        }

        .metric-card {
            padding: 12px;
            border-radius: 6px;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }

        .analysis {
            background: #eef6fc;
            border-left: 4px solid var(--color-aerobic);
            padding: 15px;
            border-radius: 4px;
            font-size: 0.9em;
            line-height: 1.6;
            color: #444;
        }

        /* ååº”å¼å¾®ç¼©ç‰ˆ */
        .mini-formula {
            font-size: 0.8em;
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 5px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
        }

        @media (max-width: 800px) { .layout { flex-direction: column; } .chart-box { height: 350px; } }
    </style>
</head>
<body>

<div class="container">
    <h2>æ°§æ°”æµ“åº¦ä¸ COâ‚‚ é‡Šæ”¾é‡çš„å…³ç³» (ç±³æ°åŠ¨åŠ›å­¦æ¨¡å‹)</h2>
    
    <div class="mini-formula">
        æ€»ååº”é€Ÿç‡å—é™äºé…¶çš„é¥±å’Œåº¦ï¼Œç¬¦åˆ Michaelis-Menten æ–¹ç¨‹
    </div>

    <div class="layout">
        <div class="chart-box">
            <canvas id="bioChart"></canvas>
        </div>

        <div class="control-panel">
            <div class="slider-group">
                <label>
                    <span>Oâ‚‚ æµ“åº¦</span>
                    <span style="color:var(--color-aerobic)"><span id="o2Val">0.0</span>%</span>
                </label>
                <input type="range" id="o2Slider" min="0" max="25" step="0.1" value="0">
                <div style="font-size:0.8em; color:#999; display:flex; justify-content:space-between; margin-top:5px;">
                    <span>0%</span>
                    <span>5% (æœ€ä½ç‚¹)</span>
                    <span>20% (è¶‹äºé¥±å’Œ)</span>
                </div>
            </div>

            <div class="metrics">
                <div class="metric-card" style="background:var(--color-anaerobic)">
                    <span>æ— æ°§å‘¼å¸é€Ÿç‡</span>
                    <span id="txtAna">0.00</span>
                </div>
                <div class="metric-card" style="background:var(--color-aerobic)">
                    <span>æœ‰æ°§å‘¼å¸é€Ÿç‡</span>
                    <span id="txtAer">0.00</span>
                </div>
                <div class="metric-card" style="background:var(--color-total)">
                    <span>æ€» COâ‚‚ é‡Šæ”¾é€Ÿç‡</span>
                    <span id="txtTot">0.00</span>
                </div>
            </div>

            <div class="analysis">
                <strong>ğŸ’¡ å®æ—¶åˆ†æï¼š</strong>
                <div id="analysisTxt">è°ƒæ•´æ»‘å—ä»¥å¼€å§‹è§‚æµ‹...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= ç§‘å­¦æ•°å­¦æ¨¡å‹ =================

    // é…ç½®å‚æ•°
    const MAX_OXYGEN = 25; // Xè½´æœ€å¤§å€¼
    
    // 1. æ— æ°§å‘¼å¸æ¨¡å‹ (Anaerobic)
    // ä½¿ç”¨å¹³æ»‘è¡°å‡å‡½æ•°ï¼Œæ¨¡æ‹Ÿå·´æ–¯å¾·æ•ˆåº”ã€‚
    // åœ¨ x=10 å·¦å³å‡ ä¹å½’é›¶ã€‚
    function getAnaerobic(x) {
        if (x >= 10) return 0;
        // ä½¿ç”¨ä½™å¼¦å‡½æ•°éƒ¨åˆ†æ¨¡æ‹Ÿå¹³æ»‘ä¸‹é™ï¼Œæ¯”ç®€å•çš„æŠ›ç‰©çº¿æ›´ç¬¦åˆç”Ÿç‰©è‡ªç„¶è¡°å‡
        // y = 1.0 * (cos(x * pi / 20) + 1) / 2 çš„å˜ä½“ï¼Œæˆ–è€…ç®€å•çš„æŠ›ç‰©çº¿
        // ä¸ºäº†ä¸¥æ ¼åœ¨10åˆ‡æ–­ï¼š
        return 1.2 * Math.pow((10 - x) / 10, 2); 
    }

    // 2. æœ‰æ°§å‘¼å¸æ¨¡å‹ (Aerobic) - æ ¸å¿ƒä¿®æ­£
    // ä½¿ç”¨ Michaelis-Menten æ–¹ç¨‹: V = Vmax * [S] / (Km + [S])
    // [S] æ˜¯æ°§æ°”æµ“åº¦ x
    // Vmax è®¾ä¸º 2.5 (æ¯”æ— æ°§èµ·ç‚¹çš„1.2è¦é«˜ï¼Œå› ä¸ºæœ‰æ°§äº§èƒ½æ•ˆç‡æé«˜ï¼Œä½†ä¸ºäº†å›¾è¡¨å¹³è¡¡ï¼ŒCO2é‡çš„Vmaxé€šå¸¸è®¾å®šä¸ºæ— æ°§èµ·ç‚¹çš„2-3å€)
    // Km (ç±³æ°å¸¸æ•°) è®¾ä¸º 5 (æ„å‘³ç€åœ¨ 5% æµ“åº¦æ—¶è¾¾åˆ°ä¸€åŠé€Ÿåº¦ï¼Œè¿™å†³å®šäº†æ›²çº¿å¼¯æ›²çš„ç¨‹åº¦)
    function getAerobic(x) {
        const Vmax = 2.8; 
        const Km = 6.0;   
        // å…¬å¼ï¼š V = Vmax * x / (Km + x)
        return (Vmax * x) / (Km + x);
    }

    // ç”Ÿæˆé«˜å¯†åº¦æ•°æ®ç‚¹ç”¨äºç»˜åˆ¶å¹³æ»‘æ›²çº¿
    const dataPoints = [];
    // æ­¥é•¿è®¾å°ä¸€ç‚¹(0.1)ï¼Œä¿è¯æ›²çº¿å¹³æ»‘
    for (let x = 0; x <= MAX_OXYGEN; x += 0.1) {
        let ana = getAnaerobic(x);
        let aer = getAerobic(x);
        dataPoints.push({
            x: x,
            ana: ana,
            aer: aer,
            tot: ana + aer
        });
    }

    // ================= Chart.js é…ç½® =================
    
    const ctx = document.getElementById('bioChart').getContext('2d');

    // æ’ä»¶ï¼šç»˜åˆ¶ç²¾å‡†çš„å‚ç›´æŒ‡ç¤ºçº¿
    const cursorPlugin = {
        id: 'cursorPlugin',
        afterDraw: (chart) => {
            if (chart.tooltip?._active?.length) return;

            const sliderVal = parseFloat(document.getElementById('o2Slider').value);
            const xScale = chart.scales.x;
            const yScale = chart.scales.y;

            // è¿™é‡Œçš„å…³é”®æ˜¯ï¼šxScale.getPixelForValue ç›´æ¥ç”¨æ•°å€¼ï¼Œä¸éœ€è¦æŸ¥ç´¢å¼•
            // å› ä¸ºæˆ‘ä»¬ä¸‹é¢é…ç½®äº† type: 'linear'
            const xPos = xScale.getPixelForValue(sliderVal);
            
            // å¦‚æœè¶…å‡ºèŒƒå›´ä¸ç»˜åˆ¶
            if (xPos < xScale.left || xPos > xScale.right) return;

            const ctx = chart.ctx;
            ctx.save();

            // 1. å‚ç›´çº¿
            ctx.beginPath();
            ctx.moveTo(xPos, yScale.top);
            ctx.lineTo(xPos, yScale.bottom);
            ctx.lineWidth = 1;
            ctx.strokeStyle = '#555';
            ctx.setLineDash([4, 4]);
            ctx.stroke();

            // 2. è®¡ç®—å½“å‰Yå€¼å¹¶ç»˜åˆ¶åœ†ç‚¹
            const currentAna = getAnaerobic(sliderVal);
            const currentAer = getAerobic(sliderVal);
            const currentTot = currentAna + currentAer;

            const drawDot = (val, color) => {
                const yPos = yScale.getPixelForValue(val);
                ctx.beginPath();
                ctx.arc(xPos, yPos, 5, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            };

            drawDot(currentAna, '#27ae60');
            drawDot(currentAer, '#2980b9');
            drawDot(currentTot, '#c0392b');

            ctx.restore();
        }
    };

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            // å¯¹äºçº¿æ€§è½´ï¼Œdatasets éœ€è¦ {x, y} æ ¼å¼çš„æ•°æ®ç»“æ„
            datasets: [
                {
                    label: 'æ— æ°§å‘¼å¸ (COâ‚‚)',
                    data: dataPoints.map(p => ({x: p.x, y: p.ana})),
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0, // éšè—åŸå§‹æ•°æ®ç‚¹ï¼Œé æ’ä»¶ç”»åŠ¨æ€ç‚¹
                    fill: true
                },
                {
                    label: 'æœ‰æ°§å‘¼å¸ (COâ‚‚)',
                    data: dataPoints.map(p => ({x: p.x, y: p.aer})),
                    borderColor: '#2980b9',
                    borderWidth: 2,
                    pointRadius: 0,
                    // ä¸å¡«å……ï¼Œä¿æŒæ¸…çˆ½
                },
                {
                    label: 'æ€»é‡Šæ”¾é‡',
                    data: dataPoints.map(p => ({x: p.x, y: p.tot})),
                    borderColor: '#c0392b',
                    borderWidth: 3,
                    borderDash: [6, 4],
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', axis: 'x', intersect: false },
            scales: {
                x: {
                    type: 'linear', // ã€å…³é”®ä¿®æ­£ã€‘ä½¿ç”¨çº¿æ€§è½´
                    position: 'bottom',
                    title: { display: true, text: 'Oâ‚‚ æµ“åº¦ (%)' },
                    min: 0,
                    max: 25,
                    grid: { display: false } // éšè—ç½‘æ ¼æ›´æ¸…æ™°
                },
                y: {
                    title: { display: true, text: 'ç›¸å¯¹ååº”é€Ÿç‡ (v)' },
                    min: 0,
                    suggestedMax: 3.0
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: (items) => `Oâ‚‚ æµ“åº¦: ${items[0].parsed.x.toFixed(1)}%`
                    }
                },
                legend: { position: 'top' }
            },
            animation: { duration: 0 }
        },
        plugins: [cursorPlugin]
    });

    // ================= äº¤äº’é€»è¾‘ =================

    const slider = document.getElementById('o2Slider');
    const domO2 = document.getElementById('o2Val');
    const domAna = document.getElementById('txtAna');
    const domAer = document.getElementById('txtAer');
    const domTot = document.getElementById('txtTot');
    const domAnalysis = document.getElementById('analysisTxt');

    function updateView(val) {
        const x = parseFloat(val);
        domO2.innerText = x.toFixed(1);

        // å®æ—¶è®¡ç®— (ç›´æ¥è°ƒç”¨æ¨¡å‹å‡½æ•°ï¼Œä¿è¯æ•°å€¼ç»å¯¹ç²¾å‡†ï¼Œä¸å†ä¾èµ–æ•°ç»„ç´¢å¼•)
        const vAna = getAnaerobic(x);
        const vAer = getAerobic(x);
        const vTot = vAna + vAer;

        domAna.innerText = vAna.toFixed(2);
        domAer.innerText = vAer.toFixed(2);
        domTot.innerText = vTot.toFixed(2);

        // æ•™å­¦é€»è¾‘åˆ¤æ–­
        let msg = "";
        
        if (x === 0) {
            msg = "<strong>æ— æ°§å‘é…µé˜¶æ®µï¼š</strong><br>å®Œå…¨ç¼ºæ°§ã€‚æ­¤æ—¶ $CO_2$ äº§é‡è¾ƒé«˜ï¼Œä½†è¿™ä¼šå¯¼è‡´æœ‰æœºç‰©å¤§é‡æ¶ˆè€—ä»¥ç»´æŒ ATP ä¾›åº”ï¼ˆæ•ˆç‡ä½ï¼‰ã€‚";
        } else if (x > 0 && x < 4) {
            msg = "<strong>å·´æ–¯å¾·æ•ˆåº”æ˜¾è‘—ï¼š</strong><br>æ°§æ°”çš„å­˜åœ¨è¿…é€ŸæŠ‘åˆ¶äº†æ— æ°§å‘¼å¸ï¼Œä½†æœ‰æ°§å‘¼å¸å—é™äºåº•ç‰©æµ“åº¦ï¼ˆ$K_m$ï¼‰å°šæœªå…¨é€Ÿè¿è¡Œï¼Œå¯¼è‡´æ€» $CO_2$ æ›²çº¿<b>æ€¥å‰§ä¸‹é™</b>ã€‚";
        } else if (x >= 4 && x <= 6) {
            msg = "<strong>æœ€ä½ç‚¹ (æœè”¬å‚¨å­˜)ï¼š</strong><br>åœ¨æ­¤åŒºé—´ï¼Œæ— æ°§å‘¼å¸å¾®å¼±ï¼Œæœ‰æ°§å‘¼å¸å°šå¼±ã€‚æ€»æ¶ˆè€—æœ€ä½ã€‚è¿™æ˜¯å‚¨å­˜æœ‰æœºç‰©çš„æœ€ä½³ç‚¹ã€‚";
        } else if (x > 6 && x < 15) {
            msg = "<strong>å¿«é€Ÿä¸Šå‡æœŸï¼š</strong><br>æ— æ°§å‘¼å¸å·²åœæ­¢ã€‚æœ‰æ°§å‘¼å¸éšæ°§æµ“åº¦å¢åŠ è€Œçº¿æ€§ä¸Šå‡ã€‚é…¶çš„æ´»æ€§ä½ç‚¹æ­£åœ¨è¢«é€æ¸å¡«å……ã€‚";
        } else {
            msg = "<strong>é¥±å’Œé˜¶æ®µ (Saturation)ï¼š</strong><br>æ³¨æ„è§‚å¯Ÿè“çº¿å’Œçº¢çº¿å˜å¾—<b>å¹³ç¼“</b>ã€‚å—é™äºçº¿ç²’ä½“æ•°é‡æˆ–å‘¼å¸é…¶çš„æ•°é‡ï¼ˆ$V_{max}$ï¼‰ï¼Œå³ä½¿æ°§æ°”å†å¢åŠ ï¼Œååº”é€Ÿç‡ä¹Ÿä¸å†æ˜¾è‘—ä¸Šå‡ã€‚ç¬¦åˆ<b>ç±³æ°æ–¹ç¨‹</b>ç‰¹æ€§ã€‚";
        }

        domAnalysis.innerHTML = msg;
        if(window.MathJax) MathJax.typesetPromise([domAnalysis]);

        // è§¦å‘é‡ç»˜ä»¥æ›´æ–°å‚ç›´çº¿
        chart.update('none');
    }

    slider.addEventListener('input', (e) => updateView(e.target.value));
    
    // åˆå§‹åŒ–
    updateView(0);

</script>
</body>
</html>
